%  Assembler.tex
%  Document created by seblovett on hind.ecs.soton.ac.uk
%  Date created: Thu 27 Mar 2014 10:13:13 GMT
%  <+Last Edited: Fri 25 Apr 2014 13:17:36 BST by hl13g10 on octopus +>

\section{Assembler}
The current instruction set architecture includes an assembler for converting assembly language into hex. This chapter outlines the required formatting and available features of this assembler. 

\subsection{Instruction Formatting}
Each instruction must be formatted using the following syntax, here ``[\dots]'' indicates an optional field:

\begin{center}\texttt{[.LABELNAME] MNEMONIC, OPERANDS, ..., :[COMMENTS]}\end{center}

\begin{center}eg. \texttt{.loop ADDI, R5, R3, \#5 :Add 5 to R3}
\end{center}

\noindent Comments may be added by preceding them with either : or ;\\

\noindent Accepted general purpose register values are: R0, R1, R2, R3, R4, R5, R6, R7, SP. These can be upper or lower case and SP is equivalently evaluated to R7.\\

\noindent Branch instructions can take either a symbolic or numeric value. 
Where a numeric must be relative and between -32 and 31 for a JMP instruction, or between -128 and 127 for any other branch type. 
If the branch exceeds the accepted range, the assembler will flag an error message. \\

\noindent All label names must begin with a `.' while .ISR/.isr and .define are special cases used for the interrupt service routine and variable definitions respectively. \\

\noindent Instruction-less or comments only lines are allowed within the assembly file. \\
\newpage
\noindent {\bf Special Case Label}

\noindent The .ISR/.isr label is reserved for the interrupt service routine and may be located anywhere within the file but must finish with a 'RETI' instruction and be no longer than 126 lines of code. Branches may occur within the ISR, but are not allowed into this subroutine with the exception of a return from a separate subroutine.\\

\subsection{Assembler Directives}
%There is one supported assembler directive  for assigning meaningful names to each of the general purpose registers. 
Symbolic label names are supported for branch-type instructions. Following the previous syntax definition for `.LABELNAME', they can be used instead of numeric branching provided they branch no further than the maximum distance allowed for the instruction used. 
Definitions are supported by the assembler. 
They are used to assign meaningful names to the GPRs to aid with programming.
Definitions can occur at any point within the file and create a mapping from that point onwards. 
Different names can be assigned to the same register, but only one is valid at a time. \\


\noindent The accepted syntax for definitions is:

\begin{center}\texttt{.define NAME REGISTER}\end{center}

\subsection{Running The Assembler}\label{sect:runningassembler}
%The assembler reads a `.asm' file and outputs a `.hex' file in hexadecimal format. 
%It is run by typing ``./assemble filename'' at the command line when in the directory of both the assembler executable and the program assembly file. ``filename'' does not have to include the .asm file extension. 
%The outputted file is saved to the same directory as the input file. \\

The assembler is a python executable and is run by typing ``./assemble.py''. 
Alternatively, the assembler can be placed in a folder on the users path and executed by running ``assemble.py''.
It supports Python versions 2.4.3 to 2.7.3.
A help prompt is given by the script if the usage is not correct, or given a \texttt{-h} or \texttt{--help} argument. 

By default, the script will output the assembled hex to a file with the same name, but with a `.hex' extension in the same directory.
The user can specify a different file to use by using a \texttt{-o filename.hex} or \texttt{--output=filename.hex} argument to the script.
The output file can also be a relative or absolute path to a different directory. 

The full usage for the script is seen in listing~\ref{lst:assemblerusage}. 
This includes the basic rules for writing the assembly language and a version log. 

\begin{lstlisting}[label=lst:assemblerusage,caption={Assembler help prompt}]
$> assemble.py 
Usage: assemble.py [-o outfile] input

---Team R4 Assembler Help---
------Version: 
 1 (CMPI addition onwards)
 2 (Changed to final ISA, added special case I's and error checking
 3 (Ajr changes - Hex output added, bug fix)
 4 (Added SP symbol)
 5 (NOP support added, help added) UNTESTED
 6 (Interrupt support added [ENAI, DISI, RETI])
 7 (Checks for duplicate Labels)
 8 (Support for any ISR location & automated startup code entry)
 9 (Support for .define)
 10 (Changed usage)
 Current is most recent iteration
Commenting uses : or ;
Labels start with '.': SPECIAL .ISR/.isr-> Interrupt Service Routine)
                       SPECIAL .define -> define new name for General Purpose Register, .define NAME R0-R7/SP
Instruction Syntax: .[LABELNAME] MNEUMONIC, OPERANDS, ..., :[COMMENTS]
Registers: R0, R1, R2, R3, R4, R5, R6, R7==SP
Branching: Symbolic and Numeric supported

Notes:
 Input files are assumed to end with a .asm extension
 Immediate value sizes are checked
 Instruction-less lines allowed
 .ISR may be located anywhere in file
 .define may be located anywhere, definition valid from location in file onwards, may replace existing definitions


Options:
  -h, --help            show this help message and exit
  -o FILE, --output=FILE
                        output file for the assembled output

\end{lstlisting}

\newpage
\subsection{Error Messages}
\begin{center}
	\centering
	\begin{tabular}{r|p{12cm}}
		\multicolumn{1}{c}{\bf Code} & \multicolumn{1}{c}{\bf Description} \\
		\hline\hline
		ERROR1& Instruction mneumonic is not recognized \\
		ERROR2& Register code within instruction is not recognized\\
		ERROR3& Branch condition code is not recognised\\
		ERROR4& Attempting to branch to undefined location \\
		ERROR5& Instruction mneumonic is not recognized \\
		ERROR6& Attempting to shift by more than 16 or perform a negative shift \\
		ERROR7& Magnitude of immediate value for ADDI, ADCI, SUBI, SUCI, LDW or STW is too large\\
		ERROR8& Magnitude of immediate value for CMPI or JMP is too large \\
		ERROR9& Magnitude of immediate value for ADDIB, SUBIB, LUI or LLI is too large \\
		ERROR10& Attempting to jump more than 127 forward or 128 backwards \\
		ERROR11& Duplicate symbolic link names \\
		ERROR12& Illegal branch to ISR \\
		ERROR13& Multiple ISRs in file \\
		ERROR14& Invalid formatting for .define directive \\
	\end{tabular}
\end{center}
